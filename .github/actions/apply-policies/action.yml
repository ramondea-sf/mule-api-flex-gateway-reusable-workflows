name: 'Apply API Policies'
description: 'Aplica polÃ­ticas de seguranÃ§a corporativas e customizadas no API Manager'
author: 'Crefisa Platform Team'

inputs:
  api_id:
    description: 'ID da API no API Manager'
    required: true
  environment:
    description: 'Nome do ambiente (dev, hml, prod)'
    required: true
  cluster:
    description: 'Nome do cluster (aws-rosa, on-premise, pix, pj)'
    required: true
  is_public:
    description: 'Se a API Ã© pÃºblica (true/false)'
    required: true
    default: 'false'
  anypoint_client_id:
    description: 'Client ID do Connected App'
    required: true
  anypoint_client_secret:
    description: 'Client Secret do Connected App'
    required: true
  working_directory:
    description: 'DiretÃ³rio de trabalho (onde estÃ£o os arquivos api/)'
    required: false
    default: '.'

outputs:
  policies_applied:
    description: 'NÃºmero de polÃ­ticas aplicadas'
    value: ${{ steps.apply-policies.outputs.policies_applied }}
  status:
    description: 'Status da aplicaÃ§Ã£o de polÃ­ticas'
    value: ${{ steps.apply-policies.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: Validar inputs
      shell: bash
      run: |
        echo "=================================================="
        echo "ðŸ” Validando parÃ¢metros de entrada"
        echo "=================================================="
        
        if [ -z "${{ inputs.api_id }}" ]; then
          echo "âŒ Erro: api_id Ã© obrigatÃ³rio"
          exit 1
        fi
        
        if [ -z "${{ inputs.environment }}" ]; then
          echo "âŒ Erro: environment Ã© obrigatÃ³rio"
          exit 1
        fi
        
        if [ -z "${{ inputs.cluster }}" ]; then
          echo "âŒ Erro: cluster Ã© obrigatÃ³rio"
          exit 1
        fi
        
        # Validar cluster
        case "${{ inputs.cluster }}" in
          aws-rosa|on-premise|pix|pj)
            echo "âœ… Cluster vÃ¡lido: ${{ inputs.cluster }}"
            ;;
          *)
            echo "âŒ Erro: Cluster invÃ¡lido: ${{ inputs.cluster }}"
            echo "   Clusters vÃ¡lidos: aws-rosa, on-premise, pix, pj"
            exit 1
            ;;
        esac
        
        # Validar is_public
        case "${{ inputs.is_public }}" in
          true|false)
            echo "âœ… is_public vÃ¡lido: ${{ inputs.is_public }}"
            ;;
          *)
            echo "âŒ Erro: is_public deve ser 'true' ou 'false'"
            exit 1
            ;;
        esac
        
        echo ""
        echo "âœ… Todos os parÃ¢metros sÃ£o vÃ¡lidos"
        echo ""

    - name: Setup yq
      shell: bash
      run: |
        if ! command -v yq &> /dev/null; then
          echo "ðŸ“¦ Instalando yq..."
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          echo "âœ… yq instalado"
        else
          echo "âœ… yq jÃ¡ estÃ¡ instalado"
          yq --version
        fi

    - name: Setup Anypoint CLI v4
      shell: bash
      run: |
        if ! command -v anypoint-cli-v4 &> /dev/null; then
          echo "ðŸ“¦ Instalando Anypoint CLI v4..."
          npm install -g anypoint-cli-v4
          echo "âœ… Anypoint CLI v4 instalado"
        else
          echo "âœ… Anypoint CLI v4 jÃ¡ estÃ¡ instalado"
          anypoint-cli-v4 --version
        fi

    - name: Aplicar polÃ­ticas
      id: apply-policies
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      env:
        ANYPOINT_CLIENT_ID: ${{ inputs.anypoint_client_id }}
        ANYPOINT_CLIENT_SECRET: ${{ inputs.anypoint_client_secret }}
      run: |
        echo "=================================================="
        echo "ðŸ”’ Aplicando polÃ­ticas de seguranÃ§a"
        echo "=================================================="
        echo "API ID: ${{ inputs.api_id }}"
        echo "Ambiente: ${{ inputs.environment }}"
        echo "Cluster: ${{ inputs.cluster }}"
        echo "API PÃºblica: ${{ inputs.is_public }}"
        echo ""
        
        # Executar script de aplicaÃ§Ã£o de polÃ­ticas
        chmod +x ${{ github.action_path }}/../../../scripts/apply-policies.sh
        ${{ github.action_path }}/../../../scripts/apply-policies.sh \
          "${{ inputs.api_id }}" \
          "${{ inputs.environment }}" \
          "${{ inputs.cluster }}" \
          "${{ inputs.is_public }}"
        
        # Marcar como sucesso
        echo "status=success" >> $GITHUB_OUTPUT
        echo ""
        echo "âœ… PolÃ­ticas aplicadas com sucesso!"


