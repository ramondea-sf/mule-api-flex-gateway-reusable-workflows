name: Reusable API Deployment.

on:
  workflow_call:
    inputs:
      environment:
        description: 'Ambiente para deploy (dev, qas, prod)'
        required: true
        type: string
      api-config-path:
        description: 'Caminho do arquivo de configuraÃ§Ã£o'
        required: false
        type: string
        default: 'api/api-config.yaml'
      swagger-path-override:
        description: 'Override do caminho do swagger'
        required: false
        type: string
        default: ''
      force-update:
        description: 'ForÃ§ar atualizaÃ§Ã£o'
        required: false
        type: boolean
        default: false
    secrets:
      ANYPOINT_CLIENT_ID:
        required: true
      ANYPOINT_CLIENT_SECRET:
        required: true
    outputs:
      api-id:
        description: "ID da API criada/atualizada"
        value: ${{ jobs.deploy-api.outputs.api-id }}
      api-version:
        description: "VersÃ£o da API deployada"
        value: ${{ jobs.validate.outputs.api-version }}
      exposed-path:
        description: "Path exposto no Flex Gateway"
        value: ${{ jobs.deploy-api.outputs.exposed-path }}

env:
  ANYPOINT_CLI_VERSION: "4.0.0"

jobs:
  validate:
    name: Validar ConfiguraÃ§Ã£o
    runs-on: ubuntu-latest
    outputs:
      api-name: ${{ steps.validate.outputs.api_name }}
      api-version: ${{ steps.validate.outputs.api_version }}
      should-deploy: ${{ steps.validate.outputs.should_deploy }}
      cluster: ${{ steps.validate.outputs.cluster }}
      is-public: ${{ steps.validate.outputs.is_public }}
      
    steps:
      - name: Checkout repositÃ³rio da API
        uses: actions/checkout@v4

      - name: Checkout repositÃ³rio de workflows (scripts e polÃ­ticas)
        uses: actions/checkout@v4
        with:
          repository: ramondea-sf/mule-api-flex-gateway-reusable-workflows
          ref: main
          path: .workflow-repo

      - name: Setup ferramentas
        uses: ./.workflow-repo/.github/actions/setup-tools
        with:
          install_nodejs: 'true'
          install_yq: 'true'
          install_anypoint_cli: 'false'
          install_jq: 'false'

      - name: Validar configuraÃ§Ã£o
        id: validate
        uses: ./.workflow-repo/.github/actions/validate-config
        with:
          api_config_path: ${{ inputs.api-config-path }}
          swagger_path_override: ${{ inputs.swagger-path-override }}
          force_update: ${{ inputs.force-update }}

      - name: Empacotar scripts, configuraÃ§Ãµes e polÃ­ticas corporativas
        run: |
          echo "ðŸ“¦ Empacotando scripts, configuraÃ§Ãµes e polÃ­ticas corporativas..."
          mkdir -p /tmp/workflow-assets
          
          # Copiar scripts
          cp -r .workflow-repo/scripts /tmp/workflow-assets/
          
          # Copiar configuraÃ§Ãµes
          cp -r .workflow-repo/config /tmp/workflow-assets/
          
          # Copiar polÃ­ticas corporativas
          cp -r .workflow-repo/policies /tmp/workflow-assets/
          
          # Tornar scripts executÃ¡veis
          chmod +x /tmp/workflow-assets/scripts/*.sh
          
          echo "âœ… Assets empacotados com sucesso!"
          ls -la /tmp/workflow-assets/scripts/
          ls -la /tmp/workflow-assets/config/
          ls -la /tmp/workflow-assets/policies/

      - name: Upload workflow assets
        uses: actions/upload-artifact@v4
        with:
          name: workflow-assets
          path: /tmp/workflow-assets/
          retention-days: 1


  validate-version:
    name: Validar Versionamento SEMVER
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should-deploy == 'true'
    outputs:
      validation-status: ${{ steps.validate-semver.outputs.validation-status }}
    
    steps:
      - name: Checkout repositÃ³rio da API
        uses: actions/checkout@v4

      - name: Checkout repositÃ³rio de workflows
        uses: actions/checkout@v4
        with:
          repository: ramondea-sf/mule-api-flex-gateway-reusable-workflows
          ref: main
          path: .workflow-repo

      - name: Setup ferramentas
        uses: ./.workflow-repo/.github/actions/setup-tools
        with:
          install_nodejs: 'true'
          install_yq: 'true'
          install_anypoint_cli: 'true'
          install_jq: 'false'
      
      - name: Ler Organization ID e Swagger Path
        id: read-config
        run: |
          ORG_ID=$(yq eval '.organizationId' api/api-config.yaml)
          SWAGGER_PATH=$(yq eval '.api.swaggerPath' api/api-config.yaml)
          echo "org-id=$ORG_ID" >> $GITHUB_OUTPUT
          echo "swagger-path=$SWAGGER_PATH" >> $GITHUB_OUTPUT

      - name: Validar versionamento SEMVER
        id: validate-semver
        uses: ramondea-sf/mule-api-flex-gateway-reusable-workflows/.github/actions/validate-api-version@main
        with:
          api-name: ${{ needs.validate.outputs.api-name }}
          current-version: ${{ needs.validate.outputs.api-version }}
          swagger-path: ${{ steps.read-config.outputs.swagger-path }}
          client-id: ${{ secrets.ANYPOINT_CLIENT_ID }}
          client-secret: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
          organization-id: ${{ steps.read-config.outputs.org-id }}

  publish-to-exchange:
    name: Publicar no Exchange
    runs-on: ubuntu-latest
    needs: [validate, validate-version]
    if: needs.validate.outputs.should-deploy == 'true'
    
    steps:
      - name: Checkout repositÃ³rio da API
        uses: actions/checkout@v4

      - name: Checkout repositÃ³rio de workflows
        uses: actions/checkout@v4
        with:
          repository: ramondea-sf/mule-api-flex-gateway-reusable-workflows
          ref: main
          path: .workflow-repo

      - name: Setup ferramentas
        uses: ./.workflow-repo/.github/actions/setup-tools
        with:
          install_nodejs: 'true'
          install_yq: 'true'
          install_anypoint_cli: 'true'
          install_jq: 'false'

      - name: Download workflow assets
        uses: actions/download-artifact@v4
        with:
          name: workflow-assets
          path: /tmp/workflow-assets/

      - name: Publicar no Exchange
        env:
          ANYPOINT_CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
          ANYPOINT_CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
        run: |
          # Usar script empacotado
          chmod +x /tmp/workflow-assets/scripts/publish-to-exchange.sh
          /tmp/workflow-assets/scripts/publish-to-exchange.sh \
            "${{ needs.validate.outputs.api-name }}" \
            "${{ needs.validate.outputs.api-version }}" \
            "${{ inputs.environment }}"

      - name: Upload Exchange Asset Info
        uses: actions/upload-artifact@v4
        with:
          name: exchange-info
          path: |
            /tmp/exchange-group-id.txt
            /tmp/exchange-asset-id.txt
            /tmp/exchange-version.txt
            /tmp/version-to-deploy.txt
          retention-days: 1

  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: [validate, validate-version, publish-to-exchange]
    outputs:
      api-id: ${{ steps.get-api-id.outputs.api-id }}
      exposed-path: ${{ steps.get-api-id.outputs.exposed-path }}
    
    steps:
      - name: Checkout repositÃ³rio da API
        uses: actions/checkout@v4

      - name: Checkout repositÃ³rio de workflows
        uses: actions/checkout@v4
        with:
          repository: ramondea-sf/mule-api-flex-gateway-reusable-workflows
          ref: main
          path: .workflow-repo

      - name: Setup ferramentas
        uses: ./.workflow-repo/.github/actions/setup-tools
        with:
          install_nodejs: 'true'
          install_yq: 'true'
          install_anypoint_cli: 'true'
          install_jq: 'true'

      - name: Download workflow assets
        uses: actions/download-artifact@v4
        with:
          name: workflow-assets
          path: /tmp/workflow-assets/

      - name: Download Exchange Asset Info
        uses: actions/download-artifact@v4
        with:
          name: exchange-info
          path: /tmp/

      - name: Obter configuraÃ§Ã£o do Gateway
        env:
          ANYPOINT_CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
          ANYPOINT_CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
        run: |
          # Ler informaÃ§Ãµes do Exchange
          ASSET_VERSION=$(cat /tmp/exchange-version.txt)
          
          # Ler configuraÃ§Ãµes
          ORG_ID=$(yq eval '.organizationId' api/api-config.yaml)
          CLUSTER=$(yq eval '.api.destinationCluster' api/api-config.yaml)
          IS_PUBLIC=$(yq eval '.api.isPublic' api/api-config.yaml)
          
          # Executar script de obtenÃ§Ã£o de gateway config
          chmod +x /tmp/workflow-assets/scripts/get-gateway-config.sh
          /tmp/workflow-assets/scripts/get-gateway-config.sh \
            "${{ inputs.environment }}" \
            "$CLUSTER" \
            "$IS_PUBLIC" \
            "$ORG_ID" \
            "$ASSET_VERSION"

      - name: Deploy API no API Manager
        env:
          ANYPOINT_CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
          ANYPOINT_CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
        run: |
          # Ler informaÃ§Ãµes necessÃ¡rias
          GATEWAY_ID=$(cat /tmp/gateway-id.txt)
          GATEWAY_VERSION=$(cat /tmp/gateway-version.txt)
          GATEWAY_LABEL=$(cat /tmp/gateway-label.txt)
          
          # Executar script de deploy
          chmod +x /tmp/workflow-assets/scripts/deploy-api.sh
          /tmp/workflow-assets/scripts/deploy-api.sh \
            "${{ needs.validate.outputs.api-name }}" \
            "${{ needs.validate.outputs.api-version }}" \
            "${{ inputs.environment }}" \
            "$GATEWAY_ID" \
            "$GATEWAY_VERSION" \
            "$GATEWAY_LABEL"

      - name: Obter API ID
        id: get-api-id
        run: |
          API_ID=$(cat /tmp/api-id.txt)
          EXPOSED_PATH=$(cat /tmp/exposed-path.txt)
          echo "api-id=$API_ID" >> $GITHUB_OUTPUT
          echo "exposed-path=$EXPOSED_PATH" >> $GITHUB_OUTPUT

      - name: Upload API Info
        uses: actions/upload-artifact@v4
        with:
          name: api-info
          path: |
            /tmp/api-id.txt
            /tmp/exposed-path.txt
            /tmp/deployed-version.txt
          retention-days: 1

  apply-policies:
    name: Aplicar PolÃ­ticas de SeguranÃ§a
    runs-on: ubuntu-latest
    needs: [validate, deploy-api]
    if: needs.validate.outputs.should-deploy == 'true'
    
    steps:
      - name: Checkout repositÃ³rio da API
        uses: actions/checkout@v4

      - name: Checkout repositÃ³rio de workflows
        uses: actions/checkout@v4
        with:
          repository: ramondea-sf/mule-api-flex-gateway-reusable-workflows
          ref: main
          path: .workflow-repo

      - name: Setup ferramentas
        uses: ./.workflow-repo/.github/actions/setup-tools
        with:
          install_nodejs: 'true'
          install_yq: 'true'
          install_anypoint_cli: 'true'
          install_jq: 'true'

      - name: Download workflow assets (scripts e polÃ­ticas corporativas)
        uses: actions/download-artifact@v4
        with:
          name: workflow-assets
          path: /tmp/workflow-assets/

      - name: Download API Info
        uses: actions/download-artifact@v4
        with:
          name: api-info
          path: /tmp/

      - name: Preparar workspace com polÃ­ticas corporativas
        run: |
          echo "=================================================="
          echo "ðŸ“‹ Preparando workspace com polÃ­ticas corporativas"
          echo "=================================================="
          
          # Criar diretÃ³rio de polÃ­ticas
          mkdir -p policies
          
          # Copiar polÃ­ticas corporativas dos assets
          if [ -d "/tmp/workflow-assets/policies/corporate" ]; then
            cp -r /tmp/workflow-assets/policies/corporate policies/
            echo "âœ… PolÃ­ticas corporativas disponibilizadas com sucesso!"
            
            # Listar polÃ­ticas disponÃ­veis
            echo ""
            echo "ðŸ“ PolÃ­ticas corporativas disponÃ­veis:"
            find policies/corporate -type f -name "*.yaml" 2>/dev/null | sort || echo "Nenhuma encontrada"
          else
            echo "âš ï¸  PolÃ­ticas corporativas nÃ£o encontradas nos assets"
            echo "   Continuando sem polÃ­ticas corporativas..."
          fi
          echo ""

      - name: Aplicar polÃ­ticas
        env:
          ANYPOINT_CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
          ANYPOINT_CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
        run: |
          API_ID=$(cat /tmp/api-id.txt)
          
          echo "=================================================="
          echo "ðŸ”’ Aplicando PolÃ­ticas de SeguranÃ§a"
          echo "=================================================="
          echo "API ID: $API_ID"
          echo "Ambiente: ${{ inputs.environment }}"
          echo "Cluster: ${{ needs.validate.outputs.cluster }}"
          echo "API PÃºblica: ${{ needs.validate.outputs.is-public }}"
          echo ""
          
          # Executar script de aplicaÃ§Ã£o de polÃ­ticas
          chmod +x /tmp/workflow-assets/scripts/apply-policies.sh
          /tmp/workflow-assets/scripts/apply-policies.sh \
            "$API_ID" \
            "${{ inputs.environment }}" \
            "${{ needs.validate.outputs.cluster }}" \
            "${{ needs.validate.outputs.is-public }}"

  apply-sla-tiers:
    name: Aplicar SLA Tiers
    runs-on: ubuntu-latest
    needs: [validate, deploy-api, apply-policies]
    if: needs.deploy-api.result == 'success'
    
    steps:
      - name: Setup Tools
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: workflow-repo
          sparse-checkout: |
            .github/actions/setup-tools
      
      - name: Install Dependencies
        uses: ./workflow-repo/.github/actions/setup-tools
      
      - name: Download workspace assets
        uses: actions/download-artifact@v4
        with:
          name: workflow-assets
          path: /tmp/workflow-assets

      - name: Checkout API workspace
        uses: actions/checkout@v4
        with:
          path: api-workspace

      - name: Download API Info
        uses: actions/download-artifact@v4
        with:
          name: api-info
          path: /tmp/

      - name: Aplicar SLA Tiers
        env:
          ANYPOINT_CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
          ANYPOINT_CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
        run: |
          cd api-workspace
          API_ID=$(cat /tmp/api-id.txt)
          
          echo "=================================================="
          echo "ðŸŽ¯ Aplicando SLA Tiers"
          echo "=================================================="
          echo "API ID: $API_ID"
          echo "Ambiente: ${{ inputs.environment }}"
          echo ""
          
          # Executar script de aplicaÃ§Ã£o de SLA Tiers
          chmod +x /tmp/workflow-assets/scripts/apply-sla-tiers.sh
          /tmp/workflow-assets/scripts/apply-sla-tiers.sh \
            "$API_ID" \
            "${{ inputs.environment }}"

  notify:
    name: Notificar Resultado
    runs-on: ubuntu-latest
    needs: [validate, deploy-api, apply-policies, apply-sla-tiers]
    if: always()
    
    steps:
      - name: Gerar resumo
        run: |
          echo "# ðŸš€ Deploy da API" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API:** ${{ needs.validate.outputs.api-name }}" >> $GITHUB_STEP_SUMMARY
          echo "**VersÃ£o:** ${{ needs.validate.outputs.api-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ambiente:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ needs.validate.outputs.cluster }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tipo:** ${{ needs.validate.outputs.is-public == 'true' && 'PÃºblica (DMZ)' || 'Privada' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status dos Jobs" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy:** ${{ needs.deploy-api.result == 'success' && 'âœ… Sucesso' || 'âŒ Falha' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PolÃ­ticas:** ${{ needs.apply-policies.result == 'success' && 'âœ… Sucesso' || needs.apply-policies.result == 'skipped' && 'â­ï¸ Pulado' || 'âŒ Falha' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SLA Tiers:** ${{ needs.apply-sla-tiers.result == 'success' && 'âœ… Sucesso' || needs.apply-sla-tiers.result == 'skipped' && 'â­ï¸ Pulado' || 'âŒ Falha' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Detalhes da API" >> $GITHUB_STEP_SUMMARY
          echo "**Path exposto:** \`${{ needs.deploy-api.outputs.exposed-path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API ID:** ${{ needs.deploy-api.outputs.api-id }}" >> $GITHUB_STEP_SUMMARY

