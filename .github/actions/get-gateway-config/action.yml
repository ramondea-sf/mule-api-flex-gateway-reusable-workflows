name: 'Get Gateway Configuration'
description: 'ObtÃ©m a configuraÃ§Ã£o do gateway (ID, versÃ£o e label) baseado no ambiente, cluster e tipo de exposiÃ§Ã£o'

inputs:
  environment:
    description: 'Ambiente (dev, qas, prod)'
    required: true
  destination-cluster:
    description: 'Cluster de destino (aws-rosa, on-premise, pix, pj)'
    required: true
  is-public:
    description: 'Se a API Ã© pÃºblica (true/false)'
    required: true

outputs:
  gateway-id:
    description: 'ID do gateway Flex'
    value: ${{ steps.get-config.outputs.gateway_id }}
  gateway-version:
    description: 'VersÃ£o do gateway Flex'
    value: ${{ steps.get-config.outputs.gateway_version }}
  gateway-label:
    description: 'Label do gateway (public/private)'
    value: ${{ steps.get-config.outputs.gateway_label }}
  gateway-type:
    description: 'Tipo do gateway (dmz/back)'
    value: ${{ steps.get-config.outputs.gateway_type }}

runs:
  using: 'composite'
  steps:
    - name: Get Gateway Configuration
      id: get-config
      shell: bash
      run: |
        ENVIRONMENT="${{ inputs.environment }}"
        CLUSTER="${{ inputs.destination-cluster }}"
        IS_PUBLIC="${{ inputs.is-public }}"
        
        echo "=================================================="
        echo "ðŸ” Obtendo configuraÃ§Ã£o do Gateway"
        echo "=================================================="
        echo "Ambiente: $ENVIRONMENT"
        echo "Cluster: $CLUSTER"
        echo "API PÃºblica: $IS_PUBLIC"
        echo ""
        
        # Determinar o tipo de gateway baseado em isPublic
        if [ "$IS_PUBLIC" == "true" ]; then
          GATEWAY_TYPE="dmz"
          GATEWAY_LABEL="$ENVIRONMENT - public"
          
          # Validar se o cluster suporta DMZ
          if [ "$CLUSTER" == "pix" ] || [ "$CLUSTER" == "pj" ]; then
            echo "âŒ Erro: Clusters PIX e PJ nÃ£o suportam APIs pÃºblicas (DMZ)"
            echo "   Altere isPublic para 'false' ou escolha outro cluster"
            exit 1
          fi
        else
          GATEWAY_TYPE="back"
          GATEWAY_LABEL="$ENVIRONMENT - private"
        fi
        
        echo "ðŸ“ Tipo de Gateway: $GATEWAY_TYPE"
        echo "ðŸ·ï¸  Label: $GATEWAY_LABEL"
        echo ""
        
        # ============================================================================
        # MAPEAMENTO DE GATEWAYS
        # ============================================================================
        # Configure os IDs e versÃµes dos gateways aqui
        # Formato: GATEWAY_{AMBIENTE}_{CLUSTER}_{TIPO}_ID e _VERSION
        
        # FunÃ§Ã£o para buscar configuraÃ§Ã£o do gateway
        get_gateway_config() {
          local env=$1
          local cluster=$2
          local type=$3
          
          # Converter para uppercase para construir nome da variÃ¡vel
          ENV_UPPER=$(echo "$env" | tr '[:lower:]' '[:upper:]')
          CLUSTER_UPPER=$(echo "$cluster" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
          TYPE_UPPER=$(echo "$type" | tr '[:lower:]' '[:upper:]')
          
          # Construir nome da variÃ¡vel: GATEWAY_DEV_AWS_ROSA_BACK_ID
          VAR_NAME_ID="GATEWAY_${ENV_UPPER}_${CLUSTER_UPPER}_${TYPE_UPPER}_ID"
          VAR_NAME_VERSION="GATEWAY_${ENV_UPPER}_${CLUSTER_UPPER}_${TYPE_UPPER}_VERSION"
          
          # Valores padrÃ£o (SUBSTITUA PELOS SEUS IDs REAIS)
          case "$env|$cluster|$type" in
            # DEV
            "dev|aws-rosa|back")
              GATEWAY_ID="07755ead-e67e-49a0-a174-953bd0b3a05d"
              GATEWAY_VERSION="1.11.0"
              ;;
            "dev|aws-rosa|dmz")
              GATEWAY_ID="GATEWAY_ID_AWS_ROSA_DMZ_DEV"
              GATEWAY_VERSION="1.11.0"
              ;;
            "dev|on-premise|back")
              GATEWAY_ID="GATEWAY_ID_ONPREM_BACK_DEV"
              GATEWAY_VERSION="1.11.0"
              ;;
            "dev|on-premise|dmz")
              GATEWAY_ID="GATEWAY_ID_ONPREM_DMZ_DEV"
              GATEWAY_VERSION="1.11.0"
              ;;
            "dev|pix|back")
              GATEWAY_ID="GATEWAY_ID_PIX_BACK_DEV"
              GATEWAY_VERSION="1.11.0"
              ;;
            "dev|pj|back")
              GATEWAY_ID="GATEWAY_ID_PJ_BACK_DEV"
              GATEWAY_VERSION="1.11.0"
              ;;
            
            # QAS
            "qas|aws-rosa|back")
              GATEWAY_ID="GATEWAY_ID_AWS_ROSA_BACK_QAS"
              GATEWAY_VERSION="1.11.0"
              ;;
            "qas|aws-rosa|dmz")
              GATEWAY_ID="GATEWAY_ID_AWS_ROSA_DMZ_QAS"
              GATEWAY_VERSION="1.11.0"
              ;;
            "qas|on-premise|back")
              GATEWAY_ID="GATEWAY_ID_ONPREM_BACK_QAS"
              GATEWAY_VERSION="1.11.0"
              ;;
            "qas|on-premise|dmz")
              GATEWAY_ID="GATEWAY_ID_ONPREM_DMZ_QAS"
              GATEWAY_VERSION="1.11.0"
              ;;
            "qas|pix|back")
              GATEWAY_ID="GATEWAY_ID_PIX_BACK_QAS"
              GATEWAY_VERSION="1.11.0"
              ;;
            "qas|pj|back")
              GATEWAY_ID="GATEWAY_ID_PJ_BACK_QAS"
              GATEWAY_VERSION="1.11.0"
              ;;
            
            # PROD
            "prod|aws-rosa|back")
              GATEWAY_ID="GATEWAY_ID_AWS_ROSA_BACK_PROD"
              GATEWAY_VERSION="1.11.0"
              ;;
            "prod|aws-rosa|dmz")
              GATEWAY_ID="GATEWAY_ID_AWS_ROSA_DMZ_PROD"
              GATEWAY_VERSION="1.11.0"
              ;;
            "prod|on-premise|back")
              GATEWAY_ID="GATEWAY_ID_ONPREM_BACK_PROD"
              GATEWAY_VERSION="1.11.0"
              ;;
            "prod|on-premise|dmz")
              GATEWAY_ID="GATEWAY_ID_ONPREM_DMZ_PROD"
              GATEWAY_VERSION="1.11.0"
              ;;
            "prod|pix|back")
              GATEWAY_ID="GATEWAY_ID_PIX_BACK_PROD"
              GATEWAY_VERSION="1.11.0"
              ;;
            "prod|pj|back")
              GATEWAY_ID="GATEWAY_ID_PJ_BACK_PROD"
              GATEWAY_VERSION="1.11.0"
              ;;
            
            *)
              echo "âŒ Erro: ConfiguraÃ§Ã£o nÃ£o encontrada para: $env|$cluster|$type"
              exit 1
              ;;
          esac
          
          echo "$GATEWAY_ID|$GATEWAY_VERSION"
        }
        
        # Obter configuraÃ§Ã£o
        CONFIG=$(get_gateway_config "$ENVIRONMENT" "$CLUSTER" "$GATEWAY_TYPE")
        GATEWAY_ID=$(echo "$CONFIG" | cut -d'|' -f1)
        GATEWAY_VERSION=$(echo "$CONFIG" | cut -d'|' -f2)
        
        # Validar se os valores foram encontrados
        if [ -z "$GATEWAY_ID" ] || [ "$GATEWAY_ID" == "null" ]; then
          echo "âŒ Erro: Gateway ID nÃ£o encontrado para:"
          echo "   Ambiente: $ENVIRONMENT"
          echo "   Cluster: $CLUSTER"
          echo "   Tipo: $GATEWAY_TYPE"
          exit 1
        fi
        
        if [ -z "$GATEWAY_VERSION" ] || [ "$GATEWAY_VERSION" == "null" ]; then
          echo "âŒ Erro: Gateway Version nÃ£o encontrada para:"
          echo "   Ambiente: $ENVIRONMENT"
          echo "   Cluster: $CLUSTER"
          echo "   Tipo: $GATEWAY_TYPE"
          exit 1
        fi
        
        echo "=================================================="
        echo "âœ… ConfiguraÃ§Ã£o do Gateway obtida"
        echo "=================================================="
        echo "Gateway ID: $GATEWAY_ID"
        echo "Gateway Version: $GATEWAY_VERSION"
        echo "Gateway Type: $GATEWAY_TYPE"
        echo "Gateway Label: $GATEWAY_LABEL"
        echo "=================================================="
        echo ""
        
        # Exportar outputs
        echo "gateway_id=$GATEWAY_ID" >> $GITHUB_OUTPUT
        echo "gateway_version=$GATEWAY_VERSION" >> $GITHUB_OUTPUT
        echo "gateway_label=$GATEWAY_LABEL" >> $GITHUB_OUTPUT
        echo "gateway_type=$GATEWAY_TYPE" >> $GITHUB_OUTPUT

