name: 'Get Gateway Configuration'
description: 'ObtÃ©m a configuraÃ§Ã£o do gateway (ID, versÃ£o e label) baseado no ambiente, cluster e tipo de exposiÃ§Ã£o'

inputs:
  environment:
    description: 'Ambiente (dev, qas, prod)'
    required: true
  destination-cluster:
    description: 'Cluster de destino (aws-rosa, on-premise, pix, pj)'
    required: true
  is-public:
    description: 'Se a API Ã© pÃºblica (true/false)'
    required: true

outputs:
  gateway-id:
    description: 'ID do gateway Flex'
    value: ${{ steps.get-config.outputs.gateway_id }}
  gateway-version:
    description: 'VersÃ£o do gateway Flex'
    value: ${{ steps.get-config.outputs.gateway_version }}
  gateway-label:
    description: 'Label do gateway (public/private)'
    value: ${{ steps.get-config.outputs.gateway_label }}
  gateway-type:
    description: 'Tipo do gateway (dmz/back)'
    value: ${{ steps.get-config.outputs.gateway_type }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repositÃ³rio de workflows (para ler gateway-config.yaml)
      uses: actions/checkout@v4
      with:
        repository: ramondea-sf/mule-api-flex-gateway-reusable-workflows
        ref: main
        path: .workflows-repo
    
    - name: Get Gateway Configuration
      id: get-config
      shell: bash
      run: |
        ENVIRONMENT="${{ inputs.environment }}"
        CLUSTER="${{ inputs.destination-cluster }}"
        IS_PUBLIC="${{ inputs.is-public }}"
        
        echo "=================================================="
        echo "ðŸ” Obtendo configuraÃ§Ã£o do Gateway"
        echo "=================================================="
        echo "Ambiente: $ENVIRONMENT"
        echo "Cluster: $CLUSTER"
        echo "API PÃºblica: $IS_PUBLIC"
        echo ""
        
        # Determinar o tipo de gateway baseado em isPublic
        if [ "$IS_PUBLIC" == "true" ]; then
          GATEWAY_TYPE="dmz"
          GATEWAY_LABEL="$ENVIRONMENT - public"
          
          # Validar se o cluster suporta DMZ
          if [ "$CLUSTER" == "pix" ] || [ "$CLUSTER" == "pj" ]; then
            echo "âŒ Erro: Clusters PIX e PJ nÃ£o suportam APIs pÃºblicas (DMZ)"
            echo "   Altere isPublic para 'false' ou escolha outro cluster"
            exit 1
          fi
        else
          GATEWAY_TYPE="back"
          GATEWAY_LABEL="$ENVIRONMENT - private"
        fi
        
        echo "ðŸ“ Tipo de Gateway: $GATEWAY_TYPE"
        echo "ðŸ·ï¸  Label: $GATEWAY_LABEL"
        echo ""
        
        # Ler configuraÃ§Ã£o do gateway-config.yaml (do repositÃ³rio de workflows)
        CONFIG_FILE=".workflows-repo/gateway-config.yaml"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Erro: Arquivo gateway-config.yaml nÃ£o encontrado"
          echo "   Certifique-se de que o arquivo existe na raiz do repositÃ³rio"
          exit 1
        fi
        
        # Extrair ID e versÃ£o do gateway
        GATEWAY_ID=$(yq eval ".gateways.$ENVIRONMENT.$CLUSTER.$GATEWAY_TYPE.id" "$CONFIG_FILE")
        GATEWAY_VERSION=$(yq eval ".gateways.$ENVIRONMENT.$CLUSTER.$GATEWAY_TYPE.version" "$CONFIG_FILE")
        
        # Validar se os valores foram encontrados
        if [ -z "$GATEWAY_ID" ] || [ "$GATEWAY_ID" == "null" ]; then
          echo "âŒ Erro: Gateway ID nÃ£o encontrado para:"
          echo "   Ambiente: $ENVIRONMENT"
          echo "   Cluster: $CLUSTER"
          echo "   Tipo: $GATEWAY_TYPE"
          echo ""
          echo "   Verifique o arquivo gateway-config.yaml"
          exit 1
        fi
        
        if [ -z "$GATEWAY_VERSION" ] || [ "$GATEWAY_VERSION" == "null" ]; then
          echo "âŒ Erro: Gateway Version nÃ£o encontrada para:"
          echo "   Ambiente: $ENVIRONMENT"
          echo "   Cluster: $CLUSTER"
          echo "   Tipo: $GATEWAY_TYPE"
          echo ""
          echo "   Verifique o arquivo gateway-config.yaml"
          exit 1
        fi
        
        echo "=================================================="
        echo "âœ… ConfiguraÃ§Ã£o do Gateway obtida"
        echo "=================================================="
        echo "Gateway ID: $GATEWAY_ID"
        echo "Gateway Version: $GATEWAY_VERSION"
        echo "Gateway Type: $GATEWAY_TYPE"
        echo "Gateway Label: $GATEWAY_LABEL"
        echo "=================================================="
        echo ""
        
        # Exportar outputs
        echo "gateway_id=$GATEWAY_ID" >> $GITHUB_OUTPUT
        echo "gateway_version=$GATEWAY_VERSION" >> $GITHUB_OUTPUT
        echo "gateway_label=$GATEWAY_LABEL" >> $GITHUB_OUTPUT
        echo "gateway_type=$GATEWAY_TYPE" >> $GITHUB_OUTPUT

