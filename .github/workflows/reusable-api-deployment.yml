name: Reusable API Deployment.

on:
  workflow_call:
    inputs:
      environment:
        description: 'Ambiente para deploy (dev, qas, prod)'
        required: true
        type: string
      api-config-path:
        description: 'Caminho do arquivo de configuraÃ§Ã£o'
        required: false
        type: string
        default: 'api/api-config.yaml'
      swagger-path-override:
        description: 'Override do caminho do swagger'
        required: false
        type: string
        default: ''
      force-update:
        description: 'ForÃ§ar atualizaÃ§Ã£o'
        required: false
        type: boolean
        default: false
    secrets:
      ANYPOINT_CLIENT_ID:
        required: true
      ANYPOINT_CLIENT_SECRET:
        required: true
    outputs:
      api-id:
        description: "ID da API criada/atualizada"
        value: ${{ jobs.deploy-api.outputs.api-id }}
      api-version:
        description: "VersÃ£o da API deployada"
        value: ${{ jobs.validate.outputs.api-version }}
      exposed-path:
        description: "Path exposto no Flex Gateway"
        value: ${{ jobs.deploy-api.outputs.exposed-path }}

env:
  ANYPOINT_CLI_VERSION: "4.0.0"

jobs:
  validate:
    name: Validar ConfiguraÃ§Ã£o
    runs-on: ubuntu-latest
    outputs:
      api-name: ${{ steps.parse-config.outputs.api-name }}
      api-version: ${{ steps.parse-config.outputs.api-version }}
      should-deploy: ${{ steps.check-changes.outputs.should-deploy }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Instalar yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validar e parsear configuraÃ§Ã£o
        id: parse-config
        run: |
          CONFIG_FILE="${{ inputs.api-config-path }}"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ Arquivo $CONFIG_FILE nÃ£o encontrado!"
            exit 1
          fi
          
          API_NAME=$(yq eval '.api.name' $CONFIG_FILE)
          API_VERSION=$(yq eval '.version.current' $CONFIG_FILE)
          SWAGGER_PATH="${{ inputs.swagger-path-override }}"
          
          if [ -z "$SWAGGER_PATH" ]; then
            SWAGGER_PATH=$(yq eval '.api.swaggerPath' $CONFIG_FILE)
          fi
          
          # ValidaÃ§Ãµes
          if [ -z "$API_NAME" ] || [ "$API_NAME" == "null" ]; then
            echo "âŒ Nome da API nÃ£o configurado!"
            exit 1
          fi
          
          if ! echo "$API_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ VersÃ£o invÃ¡lida: $API_VERSION (use SEMVER: X.Y.Z)"
            exit 1
          fi
          
          if [ ! -f "$SWAGGER_PATH" ]; then
            echo "âŒ Arquivo Swagger nÃ£o encontrado: $SWAGGER_PATH"
            exit 1
          fi
          
          echo "api-name=$API_NAME" >> $GITHUB_OUTPUT
          echo "api-version=$API_VERSION" >> $GITHUB_OUTPUT
          echo "swagger-path=$SWAGGER_PATH" >> $GITHUB_OUTPUT
          
          echo "âœ… ConfiguraÃ§Ã£o vÃ¡lida: $API_NAME v$API_VERSION"

      - name: Validar combinaÃ§Ã£o cluster + isPublic
        run: |
          CONFIG_FILE="${{ inputs.api-config-path }}"
          
          CLUSTER=$(yq eval '.api.destinationCluster' $CONFIG_FILE)
          IS_PUBLIC=$(yq eval '.api.isPublic' $CONFIG_FILE)
          
          echo "=================================================="
          echo "ðŸ” Validando configuraÃ§Ã£o de deploy"
          echo "=================================================="
          echo "Cluster: $CLUSTER"
          echo "API PÃºblica: $IS_PUBLIC"
          echo ""
          
          # Validar se PIX/PJ tentam usar DMZ pÃºblico
          if [[ ("$CLUSTER" == "pix" || "$CLUSTER" == "pj") && "$IS_PUBLIC" == "true" ]]; then
            echo "âŒ ERRO: ConfiguraÃ§Ã£o invÃ¡lida!"
            echo ""
            echo "   Cluster '$CLUSTER' nÃ£o suporta isPublic: true"
            echo "   Clusters PIX e PJ nÃ£o possuem gateway DMZ pÃºblico"
            echo ""
            echo "ðŸ’¡ SoluÃ§Ãµes:"
            echo "   1. Altere 'isPublic: false' no api-config.yaml, OU"
            echo "   2. Escolha 'destinationCluster: aws-rosa' ou 'on-premise'"
            echo ""
            exit 1
          fi
          
          # Validar se cluster Ã© vÃ¡lido
          if [[ "$CLUSTER" != "aws-rosa" && "$CLUSTER" != "on-premise" && "$CLUSTER" != "pix" && "$CLUSTER" != "pj" ]]; then
            echo "âŒ ERRO: Cluster invÃ¡lido: '$CLUSTER'"
            echo ""
            echo "ðŸ’¡ Valores vÃ¡lidos: aws-rosa, on-premise, pix, pj"
            echo ""
            exit 1
          fi
          
          echo "âœ… ConfiguraÃ§Ã£o de deploy vÃ¡lida!"
          echo "   Cluster: $CLUSTER"
          echo "   Tipo: $([ "$IS_PUBLIC" == "true" ] && echo "DMZ (pÃºblico)" || echo "BACK (privado)")"
          echo "=================================================="

      - name: Verificar mudanÃ§as
        id: check-changes
        run: |
          if [ "${{ inputs.force-update }}" == "true" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if git diff --quiet HEAD~1 HEAD -- api/ app/ 2>/dev/null; then
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          fi


  publish-to-exchange:
    name: Publicar no Exchange
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should-deploy == 'true'
    
    steps:
      - name: Checkout repositÃ³rio consumidor
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 
        with:
          node-version: '18'

      - name: Instalar Anypoint CLI
        run: npm install -g anypoint-cli-v4

      - name: Publicar no Exchange
        uses: ramondea-sf/mule-api-flex-gateway-reusable-workflows/.github/actions/publish-exchange@main
        with:
          api-name: ${{ needs.validate.outputs.api-name }}
          api-version: ${{ needs.validate.outputs.api-version }}
          environment: ${{ inputs.environment }}
          client-id: ${{ secrets.ANYPOINT_CLIENT_ID }}
          client-secret: ${{ secrets.ANYPOINT_CLIENT_SECRET }}

      - name: Upload Exchange Asset Info
        uses: actions/upload-artifact@v4
        with:
          name: exchange-info
          path: |
            /tmp/exchange-group-id.txt
            /tmp/exchange-asset-id.txt
            /tmp/exchange-version.txt
            /tmp/version-to-deploy.txt
          retention-days: 1

  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: [validate, publish-to-exchange]
    outputs:
      api-id: ${{ steps.get-api-id.outputs.api-id }}
      exposed-path: ${{ steps.get-api-id.outputs.exposed-path }}
    
    steps:
      - name: Checkout repositÃ³rio consumidor
        uses: actions/checkout@v4

      - name: Setup ferramentas
        run: |
          npm install -g anypoint-cli-v4
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get update && sudo apt-get install -y jq

      - name: Download Exchange Asset Info
        uses: actions/download-artifact@v4
        with:
          name: exchange-info
          path: /tmp/

      - name: Deploy API no API Manager
        uses: ramondea-sf/mule-api-flex-gateway-reusable-workflows/.github/actions/deploy-api-manager@main
        with:
          api-name: ${{ needs.validate.outputs.api-name }}
          api-version: ${{ needs.validate.outputs.api-version }}
          environment: ${{ inputs.environment }}
          client-id: ${{ secrets.ANYPOINT_CLIENT_ID }}
          client-secret: ${{ secrets.ANYPOINT_CLIENT_SECRET }}

      - name: Obter API ID
        id: get-api-id
        run: |
          API_ID=$(cat /tmp/api-id.txt)
          EXPOSED_PATH=$(cat /tmp/exposed-path.txt)
          echo "api-id=$API_ID" >> $GITHUB_OUTPUT
          echo "exposed-path=$EXPOSED_PATH" >> $GITHUB_OUTPUT

      - name: Upload API Info
        uses: actions/upload-artifact@v4
        with:
          name: api-info
          path: |
            /tmp/api-id.txt
            /tmp/exposed-path.txt
            /tmp/deployed-version.txt
          retention-days: 1

  # JOBS DE POLÃTICAS E ALERTAS TEMPORARIAMENTE DESABILITADOS
  # Focando apenas em Exchange e API Manager no momento
  
  # apply-policies:
  #   name: Aplicar PolÃ­ticas
  #   runs-on: ubuntu-latest
  #   needs: [validate, deploy-api]
  #   
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup ferramentas
  #       run: |
  #         npm install -g @mulesoft/anypoint-cli-v4@${{ env.ANYPOINT_CLI_VERSION }}
  #         sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
  #         sudo chmod +x /usr/local/bin/yq
  #         sudo apt-get update && sudo apt-get install -y jq
  #
  #     - name: Configurar credenciais
  #       run: |
  #         anypoint-cli-v4 conf client-id ${{ secrets.ANYPOINT_CLIENT_ID }}
  #         anypoint-cli-v4 conf client-secret ${{ secrets.ANYPOINT_CLIENT_SECRET }}
  #
  #     - name: Download API ID
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: api-info
  #         path: /tmp/
  #
  #     - name: Aplicar polÃ­ticas
  #       run: |
  #         bash scripts/apply-policies-safe.sh \
  #           "${{ inputs.environment }}"
  #
  # configure-alerts:
  #   name: Configurar Alertas
  #   runs-on: ubuntu-latest
  #   needs: [validate, deploy-api]
  #   
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup ferramentas
  #       run: |
  #         npm install -g @mulesoft/anypoint-cli-v4@${{ env.ANYPOINT_CLI_VERSION }}
  #         sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
  #         sudo chmod +x /usr/local/bin/yq
  #         sudo apt-get update && sudo apt-get install -y jq
  #
  #     - name: Configurar credenciais
  #       run: |
  #         anypoint-cli-v4 conf client-id ${{ secrets.ANYPOINT_CLIENT_ID }}
  #         anypoint-cli-v4 conf client-secret ${{ secrets.ANYPOINT_CLIENT_SECRET }}
  #
  #     - name: Download API ID
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: api-info
  #         path: /tmp/
  #
  #     - name: Configurar alertas
  #       run: |
  #         bash scripts/configure-alerts.sh "${{ inputs.environment }}"

  notify:
    name: Notificar Resultado
    runs-on: ubuntu-latest
    needs: [validate, deploy-api]
    if: always()
    
    steps:
      - name: Gerar resumo
        run: |
          echo "# ðŸš€ Deploy da API" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API:** ${{ needs.validate.outputs.api-name }}" >> $GITHUB_STEP_SUMMARY
          echo "**VersÃ£o:** ${{ needs.validate.outputs.api-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ambiente:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.deploy-api.result == 'success' && 'âœ… Sucesso' || 'âŒ Falha' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Path exposto:** ${{ needs.deploy-api.outputs.exposed-path }}" >> $GITHUB_STEP_SUMMARY
          echo "**API ID:** ${{ needs.deploy-api.outputs.api-id }}" >> $GITHUB_STEP_SUMMARY

