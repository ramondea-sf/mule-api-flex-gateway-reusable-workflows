name: 'Validar Versionamento da API'
description: 'Valida se a versÃ£o da API foi incrementada corretamente usando oasdiff'

inputs:
  api-name:
    description: 'Nome da API'
    required: true
  current-version:
    description: 'VersÃ£o atual da API'
    required: true
  swagger-path:
    description: 'Caminho do arquivo Swagger'
    required: true
  client-id:
    description: 'Anypoint Client ID'
    required: true
  client-secret:
    description: 'Anypoint Client Secret'
    required: true
  organization-id:
    description: 'Organization ID'
    required: true

outputs:
  validation-status:
    description: 'Status da validaÃ§Ã£o (passed, warning, failed)'
    value: ${{ steps.validate.outputs.status }}
  previous-version:
    description: 'VersÃ£o anterior encontrada no Exchange'
    value: ${{ steps.validate.outputs.previous-version }}

runs:
  using: 'composite'
  steps:
    - name: Instalar oasdiff
      shell: bash
      run: |
        echo "ðŸ“¦ Instalando oasdiff..."
        wget -q https://github.com/Tufin/oasdiff/releases/latest/download/oasdiff_linux_amd64 -O /tmp/oasdiff
        chmod +x /tmp/oasdiff
        /tmp/oasdiff --version || echo "Oasdiff instalado"
    
    - name: Buscar versÃ£o anterior no Exchange
      id: find-previous
      shell: bash
      env:
        ANYPOINT_CLIENT_ID: ${{ inputs.client-id }}
        ANYPOINT_CLIENT_SECRET: ${{ inputs.client-secret }}
      run: |
        echo "ðŸ” Buscando versÃµes anteriores no Exchange..."
        
        # Listar todas as versÃµes do asset
        GROUP_ID="${{ inputs.organization-id }}"
        ASSET_ID="${{ inputs.api-name }}"
        
        # Buscar informaÃ§Ãµes do asset (todas as versÃµes)
        ASSET_INFO=$(anypoint-cli-v4 exchange asset list \
          --client_id "$ANYPOINT_CLIENT_ID" \
          --client_secret "$ANYPOINT_CLIENT_SECRET" \
          --organization "$GROUP_ID" \
          --search "$ASSET_ID" \
          --output json 2>/dev/null || echo "[]")
        
        # Extrair versÃµes e ordenar
        VERSIONS=$(echo "$ASSET_INFO" | jq -r '.[] | select(.name=="${{ inputs.api-name }}") | .version' 2>/dev/null | sort -V | tail -1)
        
        if [ -n "$VERSIONS" ] && [ "$VERSIONS" != "null" ]; then
          PREVIOUS_VERSION="$VERSIONS"
          echo "previous-version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          echo "has-previous=true" >> $GITHUB_OUTPUT
          echo "âœ… VersÃ£o anterior encontrada: $PREVIOUS_VERSION"
        else
          echo "previous-version=" >> $GITHUB_OUTPUT
          echo "has-previous=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸  Nenhuma versÃ£o anterior encontrada (primeira publicaÃ§Ã£o)"
        fi
    
    - name: Baixar especificaÃ§Ã£o anterior do Exchange
      if: steps.find-previous.outputs.has-previous == 'true'
      shell: bash
      env:
        ANYPOINT_CLIENT_ID: ${{ inputs.client-id }}
        ANYPOINT_CLIENT_SECRET: ${{ inputs.client-secret }}
      run: |
        PREVIOUS_VERSION="${{ steps.find-previous.outputs.previous-version }}"
        GROUP_ID="${{ inputs.organization-id }}"
        ASSET_ID="${{ inputs.api-name }}"
        
        echo "ðŸ“¥ Baixando especificaÃ§Ã£o v$PREVIOUS_VERSION do Exchange..."
        
        # Baixar o asset anterior
        anypoint-cli-v4 exchange asset download \
          "$GROUP_ID/$ASSET_ID/$PREVIOUS_VERSION" \
          --client_id "$ANYPOINT_CLIENT_ID" \
          --client_secret "$ANYPOINT_CLIENT_SECRET" \
          --output-directory /tmp/previous-spec 2>/dev/null || true
        
        # Procurar arquivo da especificaÃ§Ã£o
        if [ -f /tmp/previous-spec/swagger.yaml ]; then
          cp /tmp/previous-spec/swagger.yaml /tmp/previous-swagger.yaml
          echo "âœ… EspecificaÃ§Ã£o anterior baixada"
        elif [ -f /tmp/previous-spec/swagger.json ]; then
          cp /tmp/previous-spec/swagger.json /tmp/previous-swagger.json
          echo "âœ… EspecificaÃ§Ã£o anterior baixada"
        else
          echo "âš ï¸  NÃ£o foi possÃ­vel baixar especificaÃ§Ã£o anterior"
          echo "skip-comparison=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Comparar especificaÃ§Ãµes e validar versÃ£o
      id: validate
      if: steps.find-previous.outputs.has-previous == 'true'
      shell: bash
      run: |
        CURRENT_VERSION="${{ inputs.current-version }}"
        PREVIOUS_VERSION="${{ steps.find-previous.outputs.previous-version }}"
        
        echo ""
        echo "=================================================="
        echo "ðŸ“Š VALIDAÃ‡ÃƒO DE VERSIONAMENTO SEMVER"
        echo "=================================================="
        echo "VersÃ£o anterior: $PREVIOUS_VERSION"
        echo "VersÃ£o nova:     $CURRENT_VERSION"
        echo ""
        
        # Verificar se arquivo anterior existe
        PREV_FILE=""
        if [ -f /tmp/previous-swagger.yaml ]; then
          PREV_FILE="/tmp/previous-swagger.yaml"
        elif [ -f /tmp/previous-swagger.json ]; then
          PREV_FILE="/tmp/previous-swagger.json"
        fi
        
        if [ -z "$PREV_FILE" ]; then
          echo "âš ï¸  NÃ£o foi possÃ­vel comparar (especificaÃ§Ã£o anterior nÃ£o disponÃ­vel)"
          echo "status=warning" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Executar oasdiff
        echo "ðŸ” Analisando mudanÃ§as na especificaÃ§Ã£o..."
        echo ""
        
        /tmp/oasdiff breaking "$PREV_FILE" "${{ inputs.swagger-path }}" --format text > /tmp/breaking-changes.txt 2>&1 || BREAKING_EXIT=$?
        /tmp/oasdiff changelog "$PREV_FILE" "${{ inputs.swagger-path }}" --format text > /tmp/changelog.txt 2>&1 || true
        
        echo "ðŸ“‹ RelatÃ³rio de MudanÃ§as:"
        echo "---"
        cat /tmp/changelog.txt | head -30
        echo "---"
        echo ""
        
        # Parsear versÃµes SEMVER
        PREV_MAJOR=$(echo $PREVIOUS_VERSION | cut -d. -f1)
        PREV_MINOR=$(echo $PREVIOUS_VERSION | cut -d. -f2)
        PREV_PATCH=$(echo $PREVIOUS_VERSION | cut -d. -f3)
        
        CURR_MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
        CURR_MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
        CURR_PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
        
        # Determinar tipo de mudanÃ§a esperada
        HAS_BREAKING=false
        if [ -s /tmp/breaking-changes.txt ] && grep -q "breaking" /tmp/breaking-changes.txt; then
          HAS_BREAKING=true
        fi
        
        # Detectar se hÃ¡ novas features (novos endpoints, novos campos)
        HAS_NEW_FEATURES=false
        if grep -qE "(added|new endpoint|new operation)" /tmp/changelog.txt 2>/dev/null; then
          HAS_NEW_FEATURES=true
        fi
        
        # Validar incremento de versÃ£o
        VALIDATION_PASSED=true
        RECOMMENDATION=""
        
        if [ "$HAS_BREAKING" = true ]; then
          echo "âš ï¸  BREAKING CHANGES DETECTADAS!"
          echo ""
          echo "MudanÃ§as incompatÃ­veis encontradas:"
          cat /tmp/breaking-changes.txt | head -10
          echo ""
          
          if [ $CURR_MAJOR -le $PREV_MAJOR ]; then
            VALIDATION_PASSED=false
            RECOMMENDATION="VocÃª tem BREAKING CHANGES. Incremente a versÃ£o MAJOR: $PREV_MAJOR.$PREV_MINOR.$PREV_PATCH â†’ $(($PREV_MAJOR + 1)).0.0"
          else
            echo "âœ… VersÃ£o MAJOR incrementada corretamente"
          fi
          
        elif [ "$HAS_NEW_FEATURES" = true ]; then
          echo "â„¹ï¸  Novas funcionalidades detectadas"
          
          if [ $CURR_MAJOR -gt $PREV_MAJOR ]; then
            echo "âœ… VersÃ£o MAJOR incrementada (aceitÃ¡vel, mas nÃ£o necessÃ¡rio)"
          elif [ $CURR_MINOR -le $PREV_MINOR ] && [ $CURR_MAJOR -eq $PREV_MAJOR ]; then
            VALIDATION_PASSED=false
            RECOMMENDATION="VocÃª adicionou funcionalidades. Incremente a versÃ£o MINOR: $PREV_MAJOR.$PREV_MINOR.$PREV_PATCH â†’ $PREV_MAJOR.$(($PREV_MINOR + 1)).0"
          else
            echo "âœ… VersÃ£o MINOR incrementada corretamente"
          fi
          
        else
          echo "â„¹ï¸  Apenas correÃ§Ãµes/ajustes detectados"
          
          if [ $CURR_MAJOR -gt $PREV_MAJOR ] || [ $CURR_MINOR -gt $PREV_MINOR ]; then
            echo "âš ï¸  VersÃ£o incrementada mais do que o necessÃ¡rio (mas aceitÃ¡vel)"
          elif [ $CURR_PATCH -le $PREV_PATCH ] && [ $CURR_MAJOR -eq $PREV_MAJOR ] && [ $CURR_MINOR -eq $PREV_MINOR ]; then
            VALIDATION_PASSED=false
            RECOMMENDATION="VocÃª fez mudanÃ§as. Incremente a versÃ£o PATCH: $PREV_MAJOR.$PREV_MINOR.$PREV_PATCH â†’ $PREV_MAJOR.$PREV_MINOR.$(($PREV_PATCH + 1))"
          else
            echo "âœ… VersÃ£o PATCH incrementada corretamente"
          fi
        fi
        
        echo ""
        echo "=================================================="
        
        if [ "$VALIDATION_PASSED" = false ]; then
          echo "âŒ VALIDAÃ‡ÃƒO FALHOU"
          echo ""
          echo "ðŸ“š LiÃ§Ã£o de SEMVER:"
          echo "$RECOMMENDATION"
          echo ""
          echo "Regras:"
          echo "â€¢ MAJOR (X.0.0): Breaking changes (incompatÃ­vel com versÃ£o anterior)"
          echo "â€¢ MINOR (x.Y.0): Novas funcionalidades (compatÃ­vel com versÃ£o anterior)"
          echo "â€¢ PATCH (x.y.Z): CorreÃ§Ãµes de bugs (compatÃ­vel com versÃ£o anterior)"
          echo ""
          echo "=================================================="
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "âœ… VALIDAÃ‡ÃƒO PASSOU"
          echo ""
          echo "Versionamento estÃ¡ correto! ðŸŽ‰"
          echo "=================================================="
          echo "status=passed" >> $GITHUB_OUTPUT
        fi
    
    - name: Primeira publicaÃ§Ã£o (sem validaÃ§Ã£o)
      if: steps.find-previous.outputs.has-previous == 'false'
      shell: bash
      run: |
        echo ""
        echo "=================================================="
        echo "ðŸŽ‰ PRIMEIRA PUBLICAÃ‡ÃƒO"
        echo "=================================================="
        echo "Esta Ã© a primeira versÃ£o da API no Exchange."
        echo "VersÃ£o: ${{ inputs.current-version }}"
        echo ""
        echo "ðŸ“š Lembre-se do SEMVER para prÃ³ximas versÃµes:"
        echo "â€¢ MAJOR (X.0.0): Breaking changes"
        echo "â€¢ MINOR (x.Y.0): Novas funcionalidades"
        echo "â€¢ PATCH (x.y.Z): CorreÃ§Ãµes de bugs"
        echo "=================================================="
        echo ""
        echo "status=passed" >> $GITHUB_OUTPUT

