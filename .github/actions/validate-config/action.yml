name: 'Validate API Configuration'
description: 'Valida configuraÃ§Ãµes da API e extrai metadados necessÃ¡rios para o deployment'
author: 'Crefisa Platform Team'

inputs:
  api_config_path:
    description: 'Caminho do arquivo de configuraÃ§Ã£o'
    required: false
    default: 'api/api-config.yaml'
  swagger_path_override:
    description: 'Override do caminho do swagger'
    required: false
    default: ''
  force_update:
    description: 'ForÃ§ar atualizaÃ§Ã£o'
    required: false
    default: 'false'

outputs:
  api_name:
    description: 'Nome da API'
    value: ${{ steps.parse-config.outputs.api-name }}
  api_version:
    description: 'VersÃ£o da API'
    value: ${{ steps.parse-config.outputs.api-version }}
  cluster:
    description: 'Cluster de destino'
    value: ${{ steps.parse-config.outputs.cluster }}
  is_public:
    description: 'Se a API Ã© pÃºblica'
    value: ${{ steps.parse-config.outputs.is-public }}
  should_deploy:
    description: 'Se deve fazer deploy'
    value: ${{ steps.check-changes.outputs.should-deploy }}

runs:
  using: 'composite'
  steps:
    - name: Validar e parsear configuraÃ§Ã£o
      id: parse-config
      shell: bash
      run: |
        CONFIG_FILE="${{ inputs.api_config_path }}"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Arquivo $CONFIG_FILE nÃ£o encontrado!"
          exit 1
        fi
        
        API_NAME=$(yq eval '.api.name' $CONFIG_FILE)
        API_VERSION=$(yq eval '.version.current' $CONFIG_FILE)
        CLUSTER=$(yq eval '.api.destinationCluster' $CONFIG_FILE)
        IS_PUBLIC=$(yq eval '.api.isPublic' $CONFIG_FILE)
        SWAGGER_PATH="${{ inputs.swagger_path_override }}"
        
        if [ -z "$SWAGGER_PATH" ]; then
          SWAGGER_PATH=$(yq eval '.api.swaggerPath' $CONFIG_FILE)
        fi
        
        # ValidaÃ§Ãµes
        if [ -z "$API_NAME" ] || [ "$API_NAME" == "null" ]; then
          echo "âŒ Nome da API nÃ£o configurado!"
          exit 1
        fi
        
        if ! echo "$API_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "âŒ VersÃ£o invÃ¡lida: $API_VERSION (use SEMVER: X.Y.Z)"
          exit 1
        fi
        
        if [ ! -f "$SWAGGER_PATH" ]; then
          echo "âŒ Arquivo Swagger nÃ£o encontrado: $SWAGGER_PATH"
          exit 1
        fi
        
        echo "api-name=$API_NAME" >> $GITHUB_OUTPUT
        echo "api-version=$API_VERSION" >> $GITHUB_OUTPUT
        echo "swagger-path=$SWAGGER_PATH" >> $GITHUB_OUTPUT
        echo "cluster=$CLUSTER" >> $GITHUB_OUTPUT
        echo "is-public=$IS_PUBLIC" >> $GITHUB_OUTPUT
        
        echo "âœ… ConfiguraÃ§Ã£o vÃ¡lida: $API_NAME v$API_VERSION"

    - name: Validar combinaÃ§Ã£o cluster + isPublic
      shell: bash
      run: |
        CONFIG_FILE="${{ inputs.api_config_path }}"
        
        CLUSTER=$(yq eval '.api.destinationCluster' $CONFIG_FILE)
        IS_PUBLIC=$(yq eval '.api.isPublic' $CONFIG_FILE)
        
        echo "=================================================="
        echo "ðŸ” Validando configuraÃ§Ã£o de deploy"
        echo "=================================================="
        echo "Cluster: $CLUSTER"
        echo "API PÃºblica: $IS_PUBLIC"
        echo ""
        
        # Validar se PIX/PJ tentam usar DMZ pÃºblico
        if [[ ("$CLUSTER" == "pix" || "$CLUSTER" == "pj") && "$IS_PUBLIC" == "true" ]]; then
          echo "âŒ ERRO: ConfiguraÃ§Ã£o invÃ¡lida!"
          echo ""
          echo "   Cluster '$CLUSTER' nÃ£o suporta isPublic: true"
          echo "   Clusters PIX e PJ nÃ£o possuem gateway DMZ pÃºblico"
          echo ""
          echo "ðŸ’¡ SoluÃ§Ãµes:"
          echo "   1. Altere 'isPublic: false' no api-config.yaml, OU"
          echo "   2. Escolha 'destinationCluster: aws-rosa' ou 'on-premise'"
          echo ""
          exit 1
        fi
        
        # Validar se cluster Ã© vÃ¡lido
        if [[ "$CLUSTER" != "aws-rosa" && "$CLUSTER" != "on-premise" && "$CLUSTER" != "pix" && "$CLUSTER" != "pj" ]]; then
          echo "âŒ ERRO: Cluster invÃ¡lido: '$CLUSTER'"
          echo ""
          echo "ðŸ’¡ Valores vÃ¡lidos: aws-rosa, on-premise, pix, pj"
          echo ""
          exit 1
        fi
        
        echo "âœ… ConfiguraÃ§Ã£o de deploy vÃ¡lida!"
        echo "   Cluster: $CLUSTER"
        echo "   Tipo: $([ "$IS_PUBLIC" == "true" ] && echo "DMZ (pÃºblico)" || echo "BACK (privado)")"
        echo "=================================================="

    - name: Verificar mudanÃ§as
      id: check-changes
      shell: bash
      run: |
        if [ "${{ inputs.force_update }}" == "true" ]; then
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if git diff --quiet HEAD~1 HEAD -- api/ app/ 2>/dev/null; then
          echo "should-deploy=false" >> $GITHUB_OUTPUT
        else
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        fi


