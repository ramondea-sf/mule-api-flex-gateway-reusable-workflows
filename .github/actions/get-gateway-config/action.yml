name: 'Get Gateway Configuration'
description: 'ObtÃ©m a configuraÃ§Ã£o do gateway (ID, versÃ£o e label) baseado no ambiente, cluster e tipo de exposiÃ§Ã£o'

inputs:
  environment:
    description: 'Ambiente (dev, qas, prod)'
    required: true
  destination-cluster:
    description: 'Cluster de destino (aws-rosa, on-premise, pix, pj)'
    required: true
  is-public:
    description: 'Se a API Ã© pÃºblica (true/false)'
    required: true
  client-id:
    description: 'Anypoint Client ID'
    required: true
  client-secret:
    description: 'Anypoint Client Secret'
    required: true
  organization-id:
    description: 'Organization ID'
    required: true

outputs:
  gateway-id:
    description: 'ID do gateway Flex'
    value: ${{ steps.get-config.outputs.gateway_id }}
  gateway-version:
    description: 'VersÃ£o do gateway Flex'
    value: ${{ steps.get-config.outputs.gateway_version }}
  gateway-label:
    description: 'Label do gateway (public/private)'
    value: ${{ steps.get-config.outputs.gateway_label }}
  gateway-type:
    description: 'Tipo do gateway (dmz/back)'
    value: ${{ steps.get-config.outputs.gateway_type }}

runs:
  using: 'composite'
  steps:
    - name: Instalar dependÃªncias
      shell: bash
      run: |
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi
        # curl geralmente jÃ¡ vem instalado no Ubuntu runner
    
    - name: Get Gateway Configuration
      id: get-config
      shell: bash
      env:
        ANYPOINT_CLIENT_ID: ${{ inputs.client-id }}
        ANYPOINT_CLIENT_SECRET: ${{ inputs.client-secret }}
      run: |
        ENVIRONMENT="${{ inputs.environment }}"
        CLUSTER="${{ inputs.destination-cluster }}"
        IS_PUBLIC="${{ inputs.is-public }}"
        ORG_ID="${{ inputs.organization-id }}"
        
        echo "=================================================="
        echo "ðŸ” Obtendo configuraÃ§Ã£o do Gateway (DinÃ¢mica)"
        echo "=================================================="
        echo "Ambiente: $ENVIRONMENT"
        echo "Cluster: $CLUSTER"
        echo "API PÃºblica: $IS_PUBLIC"
        echo "Organization ID: $ORG_ID"
        echo ""
        
        # Determinar o tipo de gateway baseado em isPublic
        if [ "$IS_PUBLIC" == "true" ]; then
          GATEWAY_TYPE="dmz"
          GATEWAY_LABEL="$ENVIRONMENT - public"
          
          # Validar se o cluster suporta DMZ
          if [ "$CLUSTER" == "pix" ] || [ "$CLUSTER" == "pj" ]; then
            echo "âŒ Erro: Clusters PIX e PJ nÃ£o suportam APIs pÃºblicas (DMZ)"
            echo "   Altere isPublic para 'false' ou escolha outro cluster"
            exit 1
          fi
        else
          GATEWAY_TYPE="back"
          GATEWAY_LABEL="$ENVIRONMENT - private"
        fi
        
        echo "ðŸ“ Tipo de Gateway: $GATEWAY_TYPE"
        echo "ðŸ·ï¸  Label: $GATEWAY_LABEL"
        echo ""
        
        # ============================================================================
        # PASSO 1: Obter Environment ID
        # ============================================================================
        echo "ðŸ” Passo 1: Obtendo ID do ambiente '$ENVIRONMENT'..."
        
        ENV_LIST=$(anypoint-cli-v4 account environment list \
          --client_id "$ANYPOINT_CLIENT_ID" \
          --client_secret "$ANYPOINT_CLIENT_SECRET" \
          --output json 2>/dev/null)
        
        if [ $? -ne 0 ] || [ -z "$ENV_LIST" ]; then
          echo "âŒ Erro ao listar ambientes"
          exit 1
        fi
        
        # Buscar environment ID pelo nome (case insensitive)
        ENV_ID=$(echo "$ENV_LIST" | jq -r ".[] | select(.name | ascii_upcase == \"$(echo $ENVIRONMENT | tr '[:lower:]' '[:upper:]')\") | .id" | head -n 1)
        
        if [ -z "$ENV_ID" ] || [ "$ENV_ID" == "null" ]; then
          echo "âŒ Erro: Ambiente '$ENVIRONMENT' nÃ£o encontrado"
          echo ""
          echo "Ambientes disponÃ­veis:"
          echo "$ENV_LIST" | jq -r '.[].name'
          exit 1
        fi
        
        echo "âœ… Environment ID: $ENV_ID"
        echo ""
        
        # ============================================================================
        # PASSO 2: Construir nome do gateway baseado na convenÃ§Ã£o
        # ============================================================================
        echo "ðŸ” Passo 2: Construindo nome do gateway..."
        
        # Naming convention para DEV
        # Formato: hub-{cluster}-{tipo}-{ambiente-suffix}
        case "$ENVIRONMENT|$CLUSTER|$GATEWAY_TYPE" in
          "dev|aws-rosa|back")
            GATEWAY_NAME="hub-aws-back-d"
            ;;
          "dev|aws-rosa|dmz")
            GATEWAY_NAME="hub-aws-front-d"
            ;;
          "dev|on-premise|back")
            GATEWAY_NAME="hub-onpre-back-d"
            ;;
          "dev|on-premise|dmz")
            GATEWAY_NAME="hub-onpre-front-d"
            ;;
          "dev|pix|back")
            GATEWAY_NAME="hub-pix-back-d"
            ;;
          "dev|pj|back")
            GATEWAY_NAME="hub-pj-back-d"
            ;;
          *)
            echo "âŒ Erro: Naming convention nÃ£o definida para: $ENVIRONMENT|$CLUSTER|$GATEWAY_TYPE"
            echo ""
            echo "ðŸ’¡ Por favor, configure o naming pattern para este ambiente/cluster"
            exit 1
            ;;
        esac
        
        echo "ðŸ“‹ Nome do gateway esperado: $GATEWAY_NAME"
        echo ""
        
        # ============================================================================
        # PASSO 3: Buscar Gateway via API
        # ============================================================================
        echo "ðŸ” Passo 3: Buscando gateway '$GATEWAY_NAME'..."
        
        GATEWAY_API_URL="https://anypoint.mulesoft.com/gatewaymanager/xapi/v1/organizations/$ORG_ID/environments/$ENV_ID/gateways?kind=selfManaged"
        
        # Obter token de acesso
        TOKEN_RESPONSE=$(curl -s -X POST "https://anypoint.mulesoft.com/accounts/api/v2/oauth2/token" \
          -H "Content-Type: application/json" \
          -d "{\"client_id\":\"$ANYPOINT_CLIENT_ID\",\"client_secret\":\"$ANYPOINT_CLIENT_SECRET\",\"grant_type\":\"client_credentials\"}")
        
        ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
        
        if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" == "null" ]; then
          echo "âŒ Erro ao obter token de acesso"
          echo "Response: $TOKEN_RESPONSE"
          exit 1
        fi
        
        # Buscar gateways
        GATEWAYS_RESPONSE=$(curl -s -X GET "$GATEWAY_API_URL" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json")
        
        if [ $? -ne 0 ]; then
          echo "âŒ Erro ao buscar gateways"
          exit 1
        fi
        
        # Filtrar gateway por nome e status RUNNING
        GATEWAY_DATA=$(echo "$GATEWAYS_RESPONSE" | jq -r ".content[] | select(.name == \"$GATEWAY_NAME\" and .status == \"RUNNING\")" | head -n 1)
        
        if [ -z "$GATEWAY_DATA" ]; then
          echo "âŒ Erro: Gateway '$GATEWAY_NAME' nÃ£o encontrado ou nÃ£o estÃ¡ RUNNING"
          echo ""
          echo "Gateways disponÃ­veis no ambiente '$ENVIRONMENT':"
          echo "$GATEWAYS_RESPONSE" | jq -r '.content[] | "\(.name) - Status: \(.status)"'
          exit 1
        fi
        
        GATEWAY_ID=$(echo "$GATEWAY_DATA" | jq -r '.id')
        
        echo "âœ… Gateway encontrado!"
        echo "   ID: $GATEWAY_ID"
        echo "   Status: $(echo "$GATEWAY_DATA" | jq -r '.status')"
        echo ""
        
        # ============================================================================
        # PASSO 4: Obter versÃ£o do gateway
        # ============================================================================
        echo "ðŸ” Passo 4: Obtendo versÃ£o do gateway..."
        
        REPLICAS_API_URL="https://anypoint.mulesoft.com/standalone/api/v1/organizations/$ORG_ID/environments/$ENV_ID/gateways/$GATEWAY_ID/replicas?pageNumber=0&pageSize=20&status=CONNECTED"
        
        REPLICAS_RESPONSE=$(curl -s -X GET "$REPLICAS_API_URL" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json")
        
        if [ $? -ne 0 ]; then
          echo "âŒ Erro ao buscar rÃ©plicas do gateway"
          exit 1
        fi
        
        # Obter todas as versÃµes e pegar a mais alta
        GATEWAY_VERSION=$(echo "$REPLICAS_RESPONSE" | jq -r '.gateway.versions[]' | sort -V | tail -n 1)
        
        if [ -z "$GATEWAY_VERSION" ] || [ "$GATEWAY_VERSION" == "null" ]; then
          echo "âŒ Erro ao obter versÃ£o do gateway"
          echo "Response: $REPLICAS_RESPONSE"
          exit 1
        fi
        
        echo "âœ… VersÃ£o do gateway: $GATEWAY_VERSION"
        echo ""
        
        echo "=================================================="
        echo "âœ… ConfiguraÃ§Ã£o do Gateway obtida"
        echo "=================================================="
        echo "Gateway ID: $GATEWAY_ID"
        echo "Gateway Version: $GATEWAY_VERSION"
        echo "Gateway Type: $GATEWAY_TYPE"
        echo "Gateway Label: $GATEWAY_LABEL"
        echo "=================================================="
        echo ""
        
        # Exportar outputs
        echo "gateway_id=$GATEWAY_ID" >> $GITHUB_OUTPUT
        echo "gateway_version=$GATEWAY_VERSION" >> $GITHUB_OUTPUT
        echo "gateway_label=$GATEWAY_LABEL" >> $GITHUB_OUTPUT
        echo "gateway_type=$GATEWAY_TYPE" >> $GITHUB_OUTPUT

